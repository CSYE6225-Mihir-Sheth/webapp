name: PostgreSQL Integration Test

on:
  pull_request:
    branches: [main]

jobs:
  connect-remote:
    runs-on: ubuntu-latest

    services:
      postgres:
        image: postgres:latest
        env:
          POSTGRES_USER: "%"
          POSTGRES_PASSWORD: "Pragna@29111999"
          POSTGRES_DB: "CLOUD_DB"
        ports:
          - 5432:5432
        options: >-
          --health-cmd pg_isready
          --health-interval 10s
          --health-timeout 5s 
          --health-retries 3

    steps:
      - name: Checkout code
        uses: actions/checkout@v2

      - name: Set up Node.js
        uses: actions/setup-node@v2
        with:
          node-version: 20.7.0
      - name: create and configure
        run: |
          touch .env
          echo port=8080 >> .env
          echo host=localhost >> .env
          echo dialect=mysql >> .env
          echo user=root >> .env
          echo password=Moin@1234 >> .env
          echo database=sys >> .env

      - name: Install dependencies
        run: npm install

      # - name: Wait for PostgreSQL to become ready
      #   run: |
      #     until PGPASSWORD=$POSTGRES_PASSWORD psql -h localhost -U $POSTGRES_USER -d $POSTGRES_DB -c '\l'; do
      #       sleep 10
      #     done

      - name: Run tests
        run: npm test
